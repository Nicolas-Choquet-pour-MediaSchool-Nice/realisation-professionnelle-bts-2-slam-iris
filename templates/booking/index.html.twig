{% extends 'base.html.twig' %}

{% block title %}Réservations{% endblock %}

{% block stylesheets %}
<style>
    .booking-container {
        display: flex;
        flex-direction: row;
        height: calc(100vh - 70px);
        overflow: hidden;
    }

    @media screen and (min-width: 600px) {
        .booking-container {
            height: auto;
        }
    }

    .calendar-section {
        flex: 1;
        padding: 20px;
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
        background-color: var(--bg-light);
    }

    .reservations-section {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: var(--card-bg);
    }

    .time-slots-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 600px;
        margin: 0 auto;
    }

    .time-slot {
        display: flex;
        align-items: center;
        border: 1px solid var(--table-border);
        border-radius: 8px;
        padding: 10px 15px;
        background-color: var(--card-bg);
        transition: background-color 0.2s;
    }

    .time-slot:hover {
        background-color: var(--dropdown-hover);
    }

    .time-slot .time {
        font-weight: bold;
        color: var(--text-muted);
        width: 80px;
        flex-shrink: 0;
    }

    .time-slot .slot-content {
        flex-grow: 1;
        font-size: 0.9em;
    }

    .time-slot.occupied {
        background-color: var(--badge-primary-bg);
        border-left: 4px solid var(--primary);
    }

    .time-slot.canceled-slot {
        background-color: var(--badge-danger-bg);
        border-left: 4px solid var(--danger);
    }

    .reservation-item.canceled {
        text-decoration: line-through;
        color: var(--text-muted);
    }

    .reservation-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 10px;
    }

    .badge-room { background-color: var(--badge-light-bg); color: var(--badge-light-text); }
    .badge-user { background-color: var(--badge-primary-bg); color: var(--badge-primary-text); }
    .badge-status { background-color: var(--badge-danger-bg); color: var(--badge-danger-text); }

    .calendar-wrapper {
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 15px;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day-name {
        text-align: center;
        font-weight: bold;
        padding: 5px;
        color: var(--text-muted);
        font-size: 0.9em;
    }

    .calendar-day {
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 4px;
        transition: background 0.2s;
        text-decoration: none;
        color: var(--text-main);
    }

    .calendar-day:hover {
        background-color: var(--dropdown-hover);
    }

    .calendar-day.active {
        background-color: var(--primary);
        color: #fff;
        font-weight: bold;
    }

    .calendar-day.empty {
        cursor: default;
    }

    .calendar-day.empty:hover {
        background: none;
    }

    .btn-nav {
        text-decoration: none;
        color: var(--primary);
        font-size: 1.5em;
        padding: 0 10px;
    }

    .btn-nav:hover {
        color: var(--primary-hover);
    }

    .reservation-card {
        border: 1px solid var(--table-border);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        background: var(--card-bg);
    }

    .reservation-time {
        font-weight: bold;
        color: var(--text-main);
    }

    .reservation-room {
        color: var(--primary);
        font-size: 1.1em;
        margin: 5px 0;
    }

    .reservation-user {
        color: var(--text-muted);
        font-size: 0.9em;
    }

    .status-canceled {
        color: var(--danger);
        font-weight: bold;
        text-transform: uppercase;
        font-size: 0.8em;
    }

    .time-slot.selected {
        background-color: var(--badge-primary-bg);
        border-color: var(--primary);
        box-shadow: inset 0 0 0 1px var(--primary);
    }

    .booking-actions-bar {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: transparent;
        border: none;
        padding: 0;
        display: none;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
        z-index: 1000;
        box-shadow: none;
        transform: translate(0, -150px);
    }

    .booking-actions-bar.active {
        display: flex;
    }

    .selected-info {
        background: var(--card-bg);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: 1px solid var(--border-color);
        font-size: 0.9em;
    }

    .btn-confirm-float {
        background-color: var(--success);
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: transform 0.2s, background-color 0.2s;
    }

    .btn-confirm-float:hover {
        background-color: #218838;
        transform: scale(1.1);
    }

    .btn-cancel-float {
        background: var(--card-bg);
        color: var(--text-muted);
        border: 1px solid var(--border-color);
        padding: 5px 15px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8em;
    }

    .room-selector {
        margin-bottom: 20px;
        padding: 10px;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
    }

    .room-selector select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        background: var(--white);
        color: var(--text-main);
        width: 100%;
        max-width: 300px;
    }

    .time-slot:not(.occupied):not(.canceled-slot) {
        cursor: pointer;
    }

    .time-slot:not(.occupied):not(.canceled-slot):hover {
        background-color: var(--dropdown-hover);
    }

    @media (max-width: 768px) {
        .booking-container {
            flex-direction: column;
            height: auto;
            overflow: visible;
        }
        .calendar-section {
            border-right: none;
            border-bottom: 1px solid var(--border-color);
        }
        .reservations-section {
            padding-bottom: 160px;
        }
    }

    .btn-cancel {
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        margin-left: 10px;
        font-size: 14px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
    }

    .btn-cancel:hover {
        opacity: 0.8;
    }

    .reservation-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block body %}
<div class="booking-container">
    <div class="calendar-section">
        <h2>Calendrier</h2>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <a href="{{ path('app_booking', {date: prevMonth|date('Y-m-d')}) }}" class="btn-nav">&laquo;</a>
                <h3>{{ currentMonth|date('F Y')|trans }}</h3>
                <a href="{{ path('app_booking', {date: nextMonth|date('Y-m-d')}) }}" class="btn-nav">&raquo;</a>
            </div>

            <div class="calendar-grid">
                <div class="calendar-day-name">Lun</div>
                <div class="calendar-day-name">Mar</div>
                <div class="calendar-day-name">Mer</div>
                <div class="calendar-day-name">Jeu</div>
                <div class="calendar-day-name">Ven</div>
                <div class="calendar-day-name">Sam</div>
                <div class="calendar-day-name">Dim</div>

                {% for day in daysInMonth %}
                    {% if day is null %}
                        <div class="calendar-day empty"></div>
                    {% else %}
                        <a href="{{ path('app_booking', {date: day|date('Y-m-d')}) }}"
                           class="calendar-day {% if day|date('Y-m-d') == selectedDate|date('Y-m-d') %}active{% endif %}">
                            {{ day|date('d') }}
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="reservations-section">
        <div class="room-selector">
            <label for="room-select">Choisir une salle :</label>
            <select id="room-select" onchange="window.location.href = '{{ path('app_booking', {date: selectedDate|date('Y-m-d')}) }}&room=' + this.value">
                {% for room in rooms %}
                    <option value="{{ room.id }}" {% if selectedRoom and selectedRoom.id == room.id %}selected{% endif %}>
                        {{ room.name }} (Capacité: {{ room.capacity }})
                    </option>
                {% endfor %}
            </select>
        </div>

        <h2 style="margin-top: 0; margin-bottom: 20px;">
            Réservations du {{ selectedDate|date('d/m/Y') }} {% if selectedRoom %}- {{ selectedRoom.name }}{% endif %}
        </h2>

        <div class="time-slots-container">
            {% for slot in timeSlots %}
                {% set slot_reservations = [] %}
                {% set has_active = false %}
                {% set has_canceled = false %}
                {% for res in reservations %}
                    {% set res_start = res.reservationStart|date('H:i') %}
                    {% set res_end = res.reservationEnd|date('H:i') %}
                    {% set slot_time = slot|date('H:i') %}

                    {% if slot_time >= res_start and slot_time < res_end %}
                        {% set slot_reservations = slot_reservations|merge([res]) %}
                        {% if res.status == 'canceled' %}
                            {% set has_canceled = true %}
                        {% else %}
                            {% set has_active = true %}
                        {% endif %}
                    {% endif %}
                {% endfor %}

                <div class="time-slot {% if has_active %}occupied{% elseif has_canceled %}canceled-slot{% endif %}"
                     data-time="{{ slot|date('H:i') }}"
                     {% if not has_active %}onclick="handleSlotClick(event, this)"{% endif %}>
                    <div class="time">{{ slot|date('H:i') }}</div>
                    <div class="slot-content">
                        {% if slot_reservations|length > 0 %}
                            {% for res in slot_reservations %}
                                {% set res_start = res.reservationStart|date('H:i') %}
                                {% set res_end = res.reservationEnd|date('H:i') %}
                                {% set slot_time = slot|date('H:i') %}
                                <div class="reservation-item {% if res.status == 'canceled' %}canceled{% endif %}">
                                    {% if slot_time == res_start %}
                                        <span class="badge-room reservation-badge">{{ res.room.name }}</span>
                                        {% if res.user.id != user.id %}
                                            <span class="badge-user reservation-badge">{{ res.user.firstname }} {{ res.user.lastname }}</span>
                                        {% endif %}

                                        {% if (res.user.id == user.id or isAdmin or isCoordinator) and res.status != 'canceled' %}
                                            <button class="btn-cancel"
                                                    onclick="cancelReservation(event, {{ res.id }}, '{{ res.reservationStart|date('H:i') }}', '{{ res.reservationEnd|date('H:i') }}')"
                                                    title="Annuler la réservation"
                                                    style="background: var(--danger); color: white;">×</button>
                                        {% endif %}
                                    {% else %}
                                        <span style="font-size: 0.8em; color: var(--text-muted); font-style: italic;">(suite)</span>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <span style="color: var(--text-muted); opacity: 0.5;">Disponible</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="booking-actions" class="booking-actions-bar">
    <div class="selected-info">
        <span id="selected-count">0</span> créneau(x)
    </div>
    <button class="btn-confirm-float" onclick="confirmBooking()" title="Enregistrer la réservation">✓</button>
    <button class="btn-cancel-float" onclick="resetSelection()">Annuler</button>
</div>

<script>
    let selectedSlots = [];

    function handleSlotClick(event, element) {
        const time = element.getAttribute('data-time');

        if (selectedSlots.includes(time)) {
            selectedSlots = selectedSlots.filter(t => t !== time);
            element.classList.remove('selected');
        } else {
            selectedSlots.push(time);
            element.classList.add('selected');
        }

        updateActionsBar();
    }

    function updateActionsBar() {
        const bar = document.getElementById('booking-actions');
        const countSpan = document.getElementById('selected-count');

        if (selectedSlots.length > 0) {
            bar.classList.add('active');
            countSpan.textContent = selectedSlots.length;
        } else {
            bar.classList.remove('active');
        }
    }

    function resetSelection() {
        document.querySelectorAll('.time-slot.selected').forEach(el => el.classList.remove('selected'));
        selectedSlots = [];
        updateActionsBar();
    }

    function confirmBooking() {
        if (selectedSlots.length === 0) return;

        const message = selectedSlots.length === 1
            ? `Réserver le créneau de ${selectedSlots[0]} ?`
            : `Réserver les ${selectedSlots.length} créneaux sélectionnés ?`;

        if (confirm(message)) {
            fetch('{{ path('app_booking_reserve') }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: '{{ selectedDate|date('Y-m-d') }}',
                    slots: selectedSlots,
                    roomId: '{{ selectedRoom ? selectedRoom.id : '' }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                    resetSelection();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue');
            });
        }
    }

    function cancelReservation(event, reservationId, startTime, endTime) {
        event.stopPropagation();
        let message = 'Voulez-vous vraiment annuler cette réservation ?';
        if (startTime && endTime) {
            message = `Voulez-vous vraiment annuler toute la réservation de ${startTime} à ${endTime} ?`;
        }
        if (confirm(message)) {
            fetch(`/booking/cancel/${reservationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Une erreur réseau est survenue');
            });
        }
    }
</script>
{% endblock %}
